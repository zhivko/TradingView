<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <title>Crypto Chart</title>
    <script>
        // Set the initial symbol from the server (defaults to BTCUSDT if not provided)
        window.initialSymbol = "{{ symbol|default('BTCUSDT') }}";
        console.log('[Template] Initial symbol set to:', window.initialSymbol);

        // Set the user email for WebSocket authentication
        window.userEmail = "{{ request.session.email or '' }}";
        console.log('[Template] User email set to:', window.userEmail);

        // Set URL parameters for chart view restoration
        window.urlStartTs = "{{ url_start_ts or '' }}";
        window.urlEndTs = "{{ url_end_ts or '' }}";
        window.urlYMin = "{{ url_y_min or '' }}";
        window.urlYMax = "{{ url_y_max or '' }}";
        console.log('[Template] URL chart view parameters:', {
            start_ts: window.urlStartTs,
            end_ts: window.urlEndTs,
            y_min: window.urlYMin,
            y_max: window.urlYMax
        });
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent scrolling on the body */
        }
        body {
            font-family: Arial, sans-serif;
            display: flex; 
            flex-direction: column;
        }
        #controls {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background-color: #f0f0f0;
        }
        
        /* Main controls row */
        .controls-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 10px;
        }
        
        /* Chart toolbar row */
        .chart-toolbar-row {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        #main {
            display: flex;
            flex: 1;
            min-height: 0; /* Important for flex-shrink to work correctly in some browsers */
        }
        #chart {
            flex-grow: 1;
            flex-basis: 0;
            -webkit-touch-callout: none; /* Prevent iOS from showing copy/share menu on long press */
            -webkit-user-select: none; /* Prevent text selection */
            user-select: none;
            -webkit-transform: translateZ(0); /* Enable hardware acceleration for better touch handling */
            transform: translateZ(0);
        }
        #right-panel {
            width: 320px;
            padding: 10px;
            background-color: #e0e0e0;
            overflow-y: auto; /* This is where the scrollbar will appear */
            font-size: 13px;
            max-height: calc(100vh - 140px); /* Constrain height to viewport minus header and toolbar */
            transition: transform 0.3s ease;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            #right-panel {
                position: fixed;
                top: 140px; /* Below controls and toolbar */
                right: 0;
                height: calc(100vh - 140px);
                transform: translateX(100%); /* Hidden by default to the right */
                z-index: 100;
                box-shadow: -2px 0 5px rgba(0,0,0,0.3);
            }

            #right-panel.open {
                transform: translateX(0); /* Visible */
            }

            #toggle-right-panel {
                display: block;
                position: fixed;
                top: 50%;
                right: 0px;
                transform: translateY(-50%);
                z-index: 101;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px 0 0 4px;
                width: 20px;
                height: 80px;
                font-size: 16px;
                cursor: pointer;
                box-shadow: -2px 0 5px rgba(0,0,0,0.3);
                opacity: 0.8;
                transition: all 0.2s;
            }

            #toggle-right-panel:hover {
                opacity: 1;
                background-color: #0056b3;
            }
            
            .controls-row {
                flex-wrap: wrap;
            }
        }

        /* Hide Plotly modebar since we use custom toolbar */
        .js-plotly-plot .modebar {
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            visibility: hidden !important;
        }

        /* Custom Toolbar Styles */
        .custom-toolbar {
            display: flex;
            justify-content: space-around;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 5px;
            width: 100%;
            max-width: 100%;
        }

        .toolbar-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .toolbar-button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .toolbar-button.active {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }

        .toolbar-button svg {
            width: 16px;
            height: 16px;
        }
        #right-panel p {
            margin: 0.5em 0; 
        }
        #event-output {
            width: 98%;
            height: 100px;
            overflow-y: auto;
            font-size: 0.9em;
            word-break: break-all;
            border: 1px solid #ccc;
            padding: 5px;
            white-space: pre-wrap;
            resize: none;
        }
        #indicator-checkbox-list div {
            margin-bottom: 5px;
        }

        /* Audio Recording Styles */
        .audio-section {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .audio-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .record-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        .record-button:hover:not(:disabled) {
            background-color: #218838;
        }

        .record-button.recording {
            background-color: #dc3545;
            animation: pulse 1s infinite;
        }

        .record-button.recording:hover {
            background-color: #c82333;
        }

        .record-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .audio-status {
            font-size: 12px;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 3px;
            text-align: center;
        }

        .audio-status.recording {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .audio-status.processing {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .audio-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .audio-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .transcription-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .transcription-header {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .transcription-text {
            font-style: italic;
            margin: 5px 0;
            color: #495057;
        }

        .transcription-meta {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-modal {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #000;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="color"] {
            height: 40px;
            cursor: pointer;
        }

        .modal-footer {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            border-radius: 0 0 8px 8px;
            text-align: right;
        }

        .modal-footer button {
            padding: 8px 16px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        #save-shape-properties {
            background-color: #007bff;
            color: white;
        }

        #save-shape-properties:hover {
            background-color: #0056b3;
        }

        #cancel-shape-properties {
            background-color: #6c757d;
            color: white;
        }

        #cancel-shape-properties:hover {
            background-color: #545b62;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Welcome to Trading View</h3>
                <span class="close-modal" onclick="closeLoginModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Please enter your email address to access the trading platform:</p>
                <form id="login-form">
                    <div class="form-group">
                        <label for="user-email">Email Address:</label>
                        <input type="email" id="user-email" placeholder="your.email@example.com" required>
                    </div>
                    <div id="login-status" style="margin-top: 10px; display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="login-submit-btn" onclick="submitLogin()" style="background-color: #007bff; color: white;">Send Confirmation Email</button>
                <button onclick="closeLoginModal()" style="background-color: #6c757d; color: white;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="controls">
        <!-- Main controls row -->
        <div class="controls-row">
            <div>
                <strong>Pair:</strong>
                <select id="symbol-select">
                    {% for symbol in supported_symbols %}
                    <option value="{{ symbol }}">{{ symbol }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <strong>Time Scale:</strong>
                <select id="resolution-select">
                    {% for resolution in supported_resolutions %}
                    <option value="{{ resolution }}">{{ resolution }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <strong>Time Range:</strong>
                <select id="range-select">
                    {% for range_option in supported_ranges %}
                    <option value="{{ range_option.value }}">{{ range_option.label }}</option>
                    {% endfor %}
                </select>
            </div>

        </div>

        <!-- Chart toolbar row - spans full width -->
        <div class="chart-toolbar-row">
            <!-- Custom Toolbar -->
            <div class="custom-toolbar">
                <button id="pan-btn" class="toolbar-button" title="Pan: Click and drag to move the chart view">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 8l4 4-4 4-4-4 4-4z"/>
                        <path d="M8 12h8"/>
                        <path d="M12 8v8"/>
                    </svg>
                </button>
                <button id="zoom-btn" class="toolbar-button" title="Zoom: Drag to select zoom rectangle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                        <line x1="11" y1="8" x2="16" y2="13"/>
                    </svg>
                </button>
                <button id="drawline-btn" class="toolbar-button" title="Draw Line: Click and drag to draw trend lines on the chart">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                        <path d="M2 2l7.586 7.586"/>
                        <circle cx="11" cy="11" r="2"/>
                    </svg>
                </button>
                <button id="screenshot-btn" class="toolbar-button" title="Take Screenshot: Download the current chart as PNG image">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <button id="drawrect-btn" class="toolbar-button" title="Draw Rectangle: Click and drag to draw rectangles on the chart">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    </svg>
                </button>
                <button id="zoom-in-btn" class="toolbar-button" title="Zoom In: Increase chart magnification">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                        <line x1="12" y1="8" x2="12" y2="14"/>
                        <line x1="8" y1="12" x2="14" y2="12"/>
                    </svg>
                </button>
                <button id="zoom-out-btn" class="toolbar-button" title="Zoom Out: Decrease chart magnification">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                        <line x1="13" y1="9" x2="9" y2="13"/>
                        <line x1="15" y1="11" x2="11" y2="15"/>
                        <line x1="8" y1="12" x2="14" y2="12"/>
                    </svg>
                </button>
                <button id="autoscale-btn" class="toolbar-button" title="Auto Scale: Automatically adjust chart zoom to show all data">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                        <line x1="13" y1="9" x2="9" y2="13"/>
                        <line x1="15" y1="11" x2="11" y2="15"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <div id="main">
        <div id="chart"></div>
        <button id="toggle-right-panel" title="Toggle Right Panel"><</button>
        <div id="right-panel">
            <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                {% if request.session.email %}
                    <strong>Logged in as:</strong> {{ request.session.email }}<br>
                    <button onclick="window.location.href='/logout'" style="margin-top: 5px; background: none; border: 1px solid #007bff; color: #007bff; padding: 5px 10px; cursor: pointer; border-radius: 4px;">‚ÜóÔ∏è Log out</button>
                    <button id="share-secret-btn" onclick="shareSecret()" style="margin-top: 5px; margin-left: 5px; background: none; border: 1px solid #28a745; color: #28a745; padding: 5px 10px; cursor: pointer; border-radius: 4px;">üîó Share</button>
                {% endif %}
            </div>
            <h3>Right Panel</h3>
            <div>
                <strong>Live Data:</strong> Always Enabled
            </div>

            <div>
                <strong>Trade Filter:</strong><br>
                <label>Min Value: <input type="range" id="min-value-slider" min="0" max="0.2" value="0" step="0.01"></label><br>
                <span id="min-volume-value">0</span>
                <span style="font-size: 11px; color: #666;"> / <span id="max-volume-value">0.2</span></span><br>
                <span id="trade-filter-countdown" style="font-size: 11px; color: #ff6600; display: none;">Updating in 10s...</span>
            </div>

            <div class="form-check" style="margin-top: 10px;">
                <input class="form-check-input" type="checkbox" id="enable-trade-trace-checkbox" checked>
                <label class="form-check-label" for="enable-trade-trace-checkbox">
                    Enable Trade Trace
                </label>
            </div>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enable-my-trades-checkbox" checked>
                <label class="form-check-label" for="enable-my-trades-checkbox">
                    Enable My Trades
                </label>
            </div>


            <hr>
            <div id="replay-section">
   <h4>Replay Controls</h4>
                <label>From: <input type="date" id="replay-from" {% if not authenticated %} disabled {% endif %}></label><br>
                <label>To: <input type="date" id="replay-to" {% if not authenticated %} disabled {% endif %}></label><br>
                <label>Speed (candle/sec): <input type="number" id="replay-speed" value="1" min="0.1" step="0.1" {% if not authenticated %} disabled {% endif %}></label><br>
                <input type="checkbox" id="use-local-ollama-checkbox" />
                <label for="use-local-ollama-checkbox">Use local Ollama</label><br>
                <div id="local-ollama-model-selection-div" style="display: none;">
                    <label for="local-ollama-model-select" style="display: block; margin-bottom: 2px;">Select Local Model:</label>
                    <select id="local-ollama-model-select" style="width: 50%; margin-bottom: 5px;"></select><br>
                </div>                
                <button id="ai-suggestion-btn" {% if not authenticated %} disabled {% endif %}>Get AI Suggestion</button><br>
                <button id="start-replay" {% if not authenticated %} disabled {% endif %}>Start</button> <button id="stop-replay" {% if not authenticated %} disabled {% endif %}></button><br>
                <textarea id="ai-suggestion" placeholder="AI suggestion..." style="width: 95%; height: 90px;" {% if not authenticated %} disabled {% endif %}></textarea>
            </div>

            <p>Additional controls or data display can go here.</p>
            <hr>
            <h4>Chart View State:</h4>
            <p><strong>X-Axis Min:</strong> <span id="x-axis-min-display">Auto</span></p>
            <p><strong>X-Axis Max:</strong> <span id="x-axis-max-display">Auto</span></p>
            <p><strong>Y-Axis Min:</strong> <span id="y-axis-min-display">Auto</span></p>
            <p><strong>Y-Axis Max:</strong> <span id="y-axis-max-display">Auto</span></p>
            <hr>
            <h4>Selected Shape:</h4>
            <div id="selected-shape-info">
                <p>No shape selected.</p>
            </div>
            <div>
                <button id="edit-shape-btn" style="display: none;">Edit line</button>
                <button id="delete-shape-btn" style="display: none;">Delete line</button>
                <button id="delete-all-shapes-btn">Delete ALL Drawings</button>
            </div>
            <hr>
            <h4>Cursor Info:</h4>
            <p><strong>Price:</strong> <span id="cursor-price-display">N/A</span></p>
            <p><strong>Time:</strong> <span id="cursor-time-display">N/A</span></p>
            <hr>
            <div class="audio-section">
                <h4>üé§ Audio Recording</h4>
                <button id="record-button" class="record-button">üé§ Start Recording</button>
                <div id="audio-status" class="audio-status">Ready to record</div>
                <div id="transcription-result" class="transcription-result">
                    <!-- Transcription results will be displayed here -->
                </div>
            </div>
            <hr>
            <h4>Event Log:</h4>
            <textarea id="event-output" readonly></textarea>
            <hr>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="showAgentTradesCheckbox">
                <label class="form-check-label" for="showAgentTradesCheckbox">
                    Show Agent Trades
                </label>
            </div>

            <hr>
            <h4>Stream Settings:</h4>
            <div>
                <label for="stream-delta-slider">Stream Delta Time (seconds): <span id="stream-delta-value-display">0</span></label>
                <input type="range" id="stream-delta-slider" min="0" max="60" value="0" step="1" style="width: 100%;">
            </div>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="show-volume-profile-checkbox" checked>
                <label class="form-check-label" for="show-volume-profile-checkbox">
                    Show Volume Profile
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="show-trade-markers-checkbox" checked>
                <label class="form-check-label" for="show-trade-markers-checkbox">
                    Show Trade Markers
                </label>
            </div>

            <h4>Indicators:</h4>
            <div id="indicator-checkbox-list">
                <div>
                    <input type="checkbox" id="indicator-macd" value="macd">
                    <label for="indicator-macd">MACD</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-rsi" value="rsi">
                    <label for="indicator-rsi">RSI</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-9-3" value="stochrsi_9_3">
                    <label for="indicator-stoch-rsi-9-3">Stochastic RSI 9,3</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-14-3" value="stochrsi_14_3">
                    <label for="indicator-stoch-rsi-14-3">Stochastic RSI 14,3</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-40-4" value="stochrsi_40_4">
                    <label for="indicator-stoch-rsi-40-4">Stochastic RSI 40,4</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-stoch-rsi-60-10" value="stochrsi_60_10">
                    <label for="indicator-stoch-rsi-60-10">Stochastic RSI 60,10</label>
                </div>
                <div class="indicator-item">
                    <input type="checkbox" id="indicator-open_interest" value="open_interest">
                    <label for="indicator-open_interest">Open Interest</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-jma" value="jma">
                    <label for="indicator-jma">Jurik MA</label>
                </div>
                <div>
                    <input type="checkbox" id="indicator-cto_line" value="cto_line">
                    <label for="indicator-cto_line">CTO Line</label>
                </div>
            </div>
        </div>
    </div>

    <div id="shape-properties-dialog" style="display:none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 10px; border: 1px solid black; z-index: 1000;">
        <h3>Shape Properties</h3>
        <p><strong>ID:</strong> <span id="shape-id-display"></span></p>

        <!-- Y Value Editing Section -->
        <div style="border: 1px solid #ccc; padding: 5px; margin: 5px 0; background-color: #f9f9f9;">
            <h4>Y Values</h4>
            <label for="start-price">Start Price (Y1):</label>
            <input type="number" id="start-price" step="0.00000001" style="width: 100%; margin-bottom: 2px;"><br>

            <label for="end-price">End Price (Y2):</label>
            <input type="number" id="end-price" step="0.00000001" style="width: 100%; margin-bottom: 2px;"><br>

<label for="shape-resolution">Time Scale:</label>
<select id="shape-resolution" style="width: 100%; margin-bottom: 2px;">
    <option value="">Select Time Scale</option>
    <option value="1m">1 Minute</option>
    <option value="5m">5 Minutes</option>
    <option value="1h">1 Hour</option>
    <option value="1d">1 Day</option>
    <option value="1w">1 Week</option>
</select><br>
        </div>

        <label for="buy-on-cross">Buy on Cross:</label>
        <input type="checkbox" id="buy-on-cross"><br>

        <label for="sell-on-cross">Sell on Cross:</label>
        <input type="checkbox" id="sell-on-cross"><br>

        <label for="amount">Amount:</label>
        <input type="number" id="amount"><br>

        <label for="amount-percent">Amount in %:</label>
        <input type="number" id="amount-percent" step="0.01"><br>

        <label for="amount-usdt">Amount in USDT:</label>
        <input type="number" id="amount-usdt" step="0.000001"><br>

        <label for="send-email-on-cross">Send an email on cross:</label>
        <input type="checkbox" id="send-email-on-cross"><br>


        <label for="email-sent">Email Sent:</label>
        <input type="checkbox" id="email-sent"><br>

        <label for="buy-sent">Buy Sent:</label>
        <input type="checkbox" id="buy-sent"><br>

        <label for="sell-sent">Sell Sent:</label>
        <input type="checkbox" id="sell-sent"><br>

        <label for="alert-actions">Trading Actions:</label>
        <textarea id="alert-actions-display" readonly style="width: 100%; height: 40px; resize: vertical;"></textarea><br>

        <label for="email-date">Email Date:</label>
        <span id="email-date-display">Not sent yet</span><br>

        <button onclick="saveShapeProperties()">Save</button>
        <button onclick="closeShapePropertiesDialog()" style="margin-left: 10px;">Cancel</button>
    </div>

    <!-- <script src="/static/plotly-2.22.0.js"></script> -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
    <!-- External JavaScript files -->
    <!-- Core utilities and API functions first -->
    <script src="/static/js/config.js?v=2"></script>
    <script src="/static/js/state.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/api.js"></script>       <!-- Ensure api.js is loaded before scripts that depend on it -->
    
    <!-- Scripts that depend on core utilities and API functions -->
    <script src="/static/js/combinedData.js"></script>
    <script src="/static/js/uiUpdaters.js"></script> <!-- Moved up to define updateShapeVisuals before chartInteractions -->
    <script src="/static/js/chartInteractions.js"></script>
    <script src="/static/js/aiFeatures.js"></script>
    <script src="/static/js/replay.js"></script>
    <script src="/static/js/settingsManager.js"></script>
    <script src="/static/js/plotlyEventHandlers.js"></script>

    <!-- Audio recording functionality -->
    <script src="/static/js/audioRecording.js"></script>

    <!-- YouTube markers integration -->
    <script src="/static/js/youtubeMarkers.js"></script>

    <!-- Main application logic last - This should be fine if dependent logic is within functions -->
    <script src="/static/js/main.js"></script>

    <!-- Login Modal JavaScript -->
    <script>
        // Check if user is authenticated on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user has email cookie (authenticated)
            const hasEmailCookie = document.cookie.includes('user_email=');
            console.log('Cookie check:', document.cookie);
            console.log('Has email cookie:', hasEmailCookie);

            if (!hasEmailCookie) {
                // Show login modal if no email cookie
                showLoginModal();
            } else {
                console.log('User is authenticated via cookie');
            }

            const toggleBtn = document.getElementById('toggle-right-panel');
            const rightPanel = document.getElementById('right-panel');

            if (toggleBtn && rightPanel) {
                console.log('Toggle button and right panel found');
                toggleBtn.addEventListener('click', function() {
                    console.log('Toggle button clicked, toggling open class');
                    rightPanel.classList.toggle('open');
                });

                // Close panel when clicking outside on mobile
                document.addEventListener('click', function(event) {
                    if (window.innerWidth <= 768) {
                        if (!rightPanel.contains(event.target) && !toggleBtn.contains(event.target)) {
                            console.log('Clicked outside, closing panel');
                            rightPanel.classList.remove('open');
                        }
                    }
                });
            } else {
                console.log('Toggle button or right panel not found');
            }

        });

        function showLoginModal() {
            const modal = document.getElementById('login-modal');
            modal.style.display = 'block';
        }

        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            modal.style.display = 'none';
        }

        async function submitLogin() {
            const emailInput = document.getElementById('user-email');
            const statusDiv = document.getElementById('login-status');
            const submitBtn = document.getElementById('login-submit-btn');

            const email = emailInput.value.trim();
            if (!email) {
                statusDiv.innerHTML = '<span style="color: red;">Please enter a valid email address.</span>';
                statusDiv.style.display = 'block';
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                statusDiv.innerHTML = '<span style="color: red;">Please enter a valid email address.</span>';
                statusDiv.style.display = 'block';
                return;
            }

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            statusDiv.innerHTML = '<span style="color: blue;">Sending confirmation email...</span>';
            statusDiv.style.display = 'block';

            try {
                const response = await fetch('/api/send-confirmation-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });

                if (response.ok) {
                    statusDiv.innerHTML = '<span style="color: green;">Confirmation email sent! Please check your email and click the confirmation link.</span>';
                    submitBtn.textContent = 'Email Sent';
                } else {
                    const errorData = await response.json();
                    statusDiv.innerHTML = `<span style="color: red;">Error: ${errorData.detail || 'Failed to send email'}</span>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Confirmation Email';
                }
            } catch (error) {
                console.error('Login error:', error);
                statusDiv.innerHTML = '<span style="color: red;">Network error. Please try again.</span>';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Confirmation Email';
            }
        }

        // Allow Enter key to submit login form
        document.addEventListener('DOMContentLoaded', function() {
            const emailInput = document.getElementById('user-email');
            if (emailInput) {
                emailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        submitLogin();
                    }
                });
            }
        });
    </script>

    <!-- Mobile panel toggle functionality and mouse wheel zoom fix -->
    <script>

        // Share secret functionality
        async function shareSecret() {
            try {
                // Get current date in dd.mm.yyyy format
                const now = new Date();
                const day = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const currentDate = `${day}.${month}.${year}`;

                // Encrypt the date
                const response = await fetch('/api/encrypt-secret', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ secret: currentDate })
                });

                if (response.ok) {
                    const data = await response.json();
                    const encryptedSecret = data.encrypted_secret;

                    // Get chart axis ranges
                    const xRange = window.gd?.layout?.xaxis?.range;
                    const yRange = window.gd?.layout?.yaxis?.range;

                    // Convert x-axis range to ISO timestamps
                    let start_ts = '';
                    let end_ts = '';
                    if (xRange && xRange.length === 2) {
                        // Convert to Date objects if they aren't already, then to ISO strings
                        const startDate = xRange[0] instanceof Date ? xRange[0] : new Date(xRange[0]);
                        const endDate = xRange[1] instanceof Date ? xRange[1] : new Date(xRange[1]);
                        start_ts = startDate.toISOString();
                        end_ts = endDate.toISOString();
                    }

                    const y_min = yRange ? yRange[0] : '';
                    const y_max = yRange ? yRange[1] : '';

                    // Create shareable URL
                    const currentUrl = window.location.origin + window.location.pathname;
                    const shareUrl = `${currentUrl}?secret=${encodeURIComponent(encryptedSecret)}&start_ts=${encodeURIComponent(start_ts)}&end_ts=${encodeURIComponent(end_ts)}&y_min=${encodeURIComponent(y_min)}&y_max=${encodeURIComponent(y_max)}`;

                    // Copy to clipboard
                    await navigator.clipboard.writeText(shareUrl);
                    alert('Encrypted share link copied to clipboard!\n\n' + shareUrl);
                } else {
                    alert('Failed to generate share link');
                }
            } catch (error) {
                console.error('Error sharing secret:', error);
                alert('Error generating share link');
            }
        }
    </script>
</body>
</html>
